---
- hosts: backup_servers
  become: true
  become_user: "{{ backup_user }}"

  tasks:
    - block:
        - name: "Check backup"
          ansible.builtin.include_tasks:
            file: ./tasks/check_borg_backup.yml
          loop: "{{ backup_configs }}"
          vars:
            borg_repository_name: "{{ item.borg_repository_name }}"
            borg_repository_passphrase: "{{ item.borg_repository_passphrase }}"
            borg_repository_dump_path: "{{ item.borg_repository_dump_path | default(omit) }}"
          loop_control:
              label: "{{ item.borg_repository_name }}"
      rescue:
        - name: Send a mail on failure
          community.general.mail:
            host: "{{ mail_host }}"
            port: "{{ mail_port }}"
            password: "{{ mail_password }}"
            username: "{{ mail_from }}"
            from: "{{ mail_from }}"
            to: "{{ mail_to }}"
            subject: Some backup checks failed
            body: "Some backup checks failed on server. Please check the semaphore logs for more details."

        - name: Report failure
          ansible.builtin.fail:
            msg: "Some backup checks failed"
